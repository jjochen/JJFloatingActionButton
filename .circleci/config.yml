version: 2

jobs:
  build-and-test-ios11-iphonex:

    macos:
      xcode: "9.0"

    steps:
      - checkout

      - run:
          name: Fetch CocoaPods Specs
          command: curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf

      - run:
          name: Install CocoaPods
          command: pod install --project-directory=Example

      - run:
          name: Build and run tests
          command: set -o pipefail &&
                      xcodebuild
                      CODE_SIGNING_REQUIRED=NO
                      CODE_SIGN_IDENTITY=
                      PROVISIONING_PROFILE=
                      -sdk iphonesimulator
                      -destination 'platform=iOS Simulator,OS=11.0,name=iPhone X'
                      -workspace Example/JJFloatingActionButton.xcworkspace
                      -scheme JJFloatingActionButton_Example
                      -enableCodeCoverage YES
                      clean build test |
                      tee $CIRCLE_ARTIFACTS/xcode_raw.log |
                      xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml

      - run: 
          name: Update Codecov
          command: bash <(curl -s https://codecov.io/bash)

jobs:
  lint-podspec:

    macos:
      xcode: "9.0"

    steps:
      - checkout

      - run:
          name: Lint Podspec
          command: pod lib lint


workflows:
  version: 2
  test:
    jobs:
      - build-and-test-ios11-iphonex
      - lint-podspec