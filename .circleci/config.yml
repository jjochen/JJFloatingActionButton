version: 2.1

executors:

  default: &default
    macos:
      xcode: 11.3.1
    shell: /bin/bash --login -eo pipefail

  ios13-iphone-11-pro-max:
    <<: *default
    macos:
      xcode: 11.3.1
    environment:
      SIMULATOR_OS: 13.3
      DESTINATION: platform=iOS Simulator,OS=13.3,name=iPhone 11 Pro Max
      SIMULATOR: iPhone 11 Pro Max (13.3) [

  ios12-iphone-xs-max:
    <<: *default
    macos:
      xcode: 10.3.0
    environment:
      SIMULATOR_OS: 12.4
      DESTINATION: platform=iOS Simulator,OS=12.4,name=iPhone Xs Max
      SIMULATOR: iPhone Xs Max (12.4) [

  ios11-iphone-x:
    <<: *default
    macos:
      xcode: 10.3.0
    environment:
      DESTINATION: platform=iOS Simulator,OS=11.2,name=iPhone X
      SIMULATOR: iPhone X (11.2) [

  ios10-iphone-7:
    <<: *default
    macos:
      xcode: 10.3.0
    shell: /bin/bash --login -eo pipefail
    environment:
      DESTINATION: platform=iOS Simulator,OS=10.3.1,name=iPhone 7
      SIMULATOR: iPhone 7 (10.3.1) [


commands:

  change-ruby:
    description: Select the correct version of ruby
    steps:
      - run:
          name: Set Ruby Version
          command: echo 'chruby ruby-2.6' >> ~/.bash_profile

  update-bundler:
    description: Update bundler to newest version
    steps:
      - run:
          name: Update bundler
          command: gem install bundler

  restore-gem-cache:
    description: Restore gems from cache
    steps:
      - restore_cache:
          keys:
            - v1-gem-cache-{{ checksum "Gemfile.lock" }}
            - v1-gem-cache

  bundle-install:
    description: Install gems
    steps:
      - run:
          name: Bundle install
          command: bundle install --path vendor/bundle

  save-gem-cache:
    description: Save gems to cache
    steps:
      - save_cache:
          key: v1-gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
          - vendor/bundle

  start-simulator:
    description: Start simulator
    steps:
      - run:
          name: Start simulator
          command: xcrun instruments -w "$SIMULATOR" || true

  fetch-cocoapods-specs:
    description: Fetch CocoaPods repository from S3
    steps:
      - run:
          name: Fetch CocoaPods Specs
          command: curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf

  restore-pods-cache:
    description: Restore pods directory from cache
    steps:
      - restore_cache:
          keys:
            - v1-pods-cache-{{ checksum "Example/Podfile.lock" }}
            - v1-pods-cache

  install-cocoapods:
    description: Install cocoapods of example project
    steps:
      - run:
          name: Install CocoaPods
          command: bundle exec pod install --project-directory=Example

  save-pods-cache:
    description: Save pods directory to cache
    steps:
      - save_cache:
          key: v1-pods-cache-{{ checksum "Example/Podfile.lock" }}
          paths:
            - Example/Pods

  run-tests:
    description: Run tests on sepcific device
    steps:
      - run:
          name: Build and run tests
          command: bundle exec rake test_destination

  update-codecov:
    description: Upload coverage information to Codecov
    steps:
      - run:
          name: Update Codecov
          command: bash <(curl -s https://codecov.io/bash)

  store-test-reports:
    description: Store reports
    steps:
      - store_artifacts:
          path: build/reports/junit.xml
      - store_test_results:
          path: build/reports/junit.xml

  setup-gems:
    description: Update bundler and install gems
    steps:
      - change-ruby
      - update-bundler
      - restore-gem-cache
      - bundle-install
      - save-gem-cache

  setup-cocoapods:
    description: Fetch specs and install cocoapods
    steps:
      - fetch-cocoapods-specs
      - restore-pods-cache
      - install-cocoapods
      - save-pods-cache

  lint-podspec:
    description: Lint Podspec
    steps:
      - run:
          name: Lint Podspec
          command: bundle exec rake lint_podspec

  generate-documentation:
    description: Build Documentation
    steps:
      - run:
          name: Build Documentation
          command: bundle exec rake generate_documentation

  generate-changelog:
    description: Generate Changelog
    steps:
      - run:
          name: Generate Changelog
          command: bundle exec rake generate_changelog

  swiftlint:
    description: Run Swiftlint
    steps:
      - run:
          name: Swiftlint
          command: swiftlint lint --reporter junit | tee junit.xml

  store-lint-reports:
    description: Store reports
    steps:
      - store_artifacts:
          path: junit.xml
      - store_test_results:
          path: junit.xml

  release-next-major-version:
    description: Create major release pull request
    steps:
      - run:
          name: Create major release pull request
          command: bundle exec rake release_next_version 'major'

  release-next-minor-version:
    description: Create minor release pull request
    steps:
      - run:
          name: Create minor release pull request
          command: bundle exec rake release_next_version 'minor'

  release-next-patch-version:
    description: Create patch release pull request
    steps:
      - run:
          name: Create patch release pull request
          command: bundle exec rake release_next_version 'patch'

  create-github-release:
    description: Create version tag on github
    steps:
      - run:
          name: Create version tag on github
          command: bundle exec rake create_github_release

  close-github-milestone:
    description: Close milestone on github
    steps:
      - run:
          name: Close milestone on github
          command: bundle exec rake close_github_milestone

  push-podspec:
    description: Push Podspec to trunk
    steps:
      - run:
          name: Push Podspec to trunk
          command: bundle exec rake push_podspec


aliases:

  - &filter-version-tags-only
    filters:
      tags:
        only: /^[0-9]+\.[0-9]+\.[0-9]+$/
      branches:
        ignore: /.*/

  - &filter-major-release-tags-only
    filters:
      tags:
        only: major-release
      branches:
        ignore: /.*/

  - &filter-minor-release-tags-only
    filters:
      tags:
        only: minor-release
      branches:
        ignore: /.*/

  - &filter-patch-release-tags-only
    filters:
      tags:
        only: patch-release
      branches:
        ignore: /.*/


jobs:

  build-and-test-ios13-iphone11promax:
    executor: ios13-iphone-11-pro-max
    steps:
      - checkout
      - setup-gems
      - start-simulator
      - setup-cocoapods
      - run-tests
      - store-test-reports

  build-and-test-ios12-iphonexsmax:
    executor: ios12-iphone-xs-max
    steps:
      - checkout
      - setup-gems
      - start-simulator
      - setup-cocoapods
      - run-tests
      - update-codecov
      - store-test-reports

  build-and-test-ios11-iphonex:
    executor: ios11-iphone-x
    steps:
      - checkout
      - setup-gems
      - start-simulator
      - setup-cocoapods
      - run-tests
      - store-test-reports

  build-and-test-ios10-iphone7:
    executor: ios10-iphone-7
    steps:
      - checkout
      - setup-gems
      - start-simulator
      - setup-cocoapods
      - run-tests
      - store-test-reports

  lint-podspec:
    executor: default
    steps:
      - checkout
      - setup-gems
      - lint-podspec

  build-documentation:
    executor: default
    steps:
      - checkout
      - setup-gems
      - setup-cocoapods
      - generate-documentation

  generate-changelog:
    executor: default
    steps:
      - checkout
      - setup-gems
      - generate-changelog

  swiftlint:
    docker:
      - image: dantoml/swiftlint:latest
    steps:
      - checkout
      - swiftlint
      - store-lint-reports

  create-major-release-pull-request:
    executor: default
    steps:
      - checkout
      - setup-gems
      - setup-cocoapods
      - release-next-major-version

  create-minor-release-pull-request:
    executor: default
    steps:
      - checkout
      - setup-gems
      - setup-cocoapods
      - release-next-minor-version

  create-patch-release-pull-request:
    executor: default
    steps:
      - checkout
      - setup-gems
      - setup-cocoapods
      - release-next-patch-version

  create-version-tag:
    executor: default
    steps:
      - checkout
      - setup-gems
      - create-github-release

  close-milestone:
    executor: default
    steps:
      - checkout
      - setup-gems
      - close-github-milestone

  push-podspec:
    executor: default
    steps:
      - checkout
      - setup-gems
      - setup-cocoapods
      - push-podspec


workflows:
  version: 2.1

  run-tests:
    jobs:
      - lint-podspec
      - swiftlint
      - build-and-test-ios13-iphone11promax
      - build-and-test-ios12-iphonexsmax
      - build-documentation
      - generate-changelog
      - create-version-tag:
          requires:
            - lint-podspec
            - swiftlint
            - build-and-test-ios13-iphone11promax
            - build-and-test-ios12-iphonexsmax
            - build-documentation
            - generate-changelog
          filters:
            branches:
              only: master

  deploy:
    jobs:
      - close-milestone: *filter-version-tags-only
      - push-podspec: *filter-version-tags-only
      - create-major-release-pull-request: *filter-major-release-tags-only
      - create-minor-release-pull-request: *filter-minor-release-tags-only
      - create-patch-release-pull-request: *filter-patch-release-tags-only
